<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Sistema de Navegación - UniSabana</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            background: #f4f6f9;
        }

        #sidebar {
            width: 300px;
            overflow-y: auto;
            padding: 20px;
            background: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #map-container {
            position: relative;
            flex: 1;
            background: url('/static/campus_map.png') no-repeat center/contain;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: all;
            width: 100%;
            height: 100%;
        }

        .sortable-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #ccc;
            min-height: 50px;
            background: #fff;
        }

        .sortable-list li {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
            cursor: grab;
            background: #f8f9fa;
            margin-bottom: 2px;
            border-radius: 4px;
        }

        .node-label {
            font-size: 12px;
            fill: #000;
            font-weight: 500;
            text-shadow: 1px 1px #fff;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <h4 class="mb-3">Nodos</h4>
        <div id="node-list" class="mb-3"></div>
        <button id="add-node-btn" class="btn btn-primary w-100 mb-2">Agregar Nodo</button>
        <button id="connect-btn" class="btn btn-warning w-100 mb-3">Conectar Nodos</button>
        <hr>
        <h5 class="mb-2">Ruta más corta</h5>
        <div class="mb-2">
            <label class="form-label">Origen:</label>
            <select id="origin-select" class="form-select"></select>
        </div>
        <div class="mb-2">
            <label class="form-label">Paradas intermedias:</label>
            <ul id="waypoints-list" class="sortable-list"></ul>
        </div>
        <div class="mb-2">
            <label class="form-label">Destino:</label>
            <select id="dest-select" class="form-select"></select>
        </div>
        <div class="d-grid gap-2">
            <button id="calc-btn" class="btn btn-success">Calcular Ruta</button>
            <button id="clear-btn" class="btn btn-outline-secondary">Limpiar Ruta</button>
        </div>
        <div id="route-result" class="mt-3 text-primary fw-bold"></div>
        <hr>
        <h5 class="mb-2">Exportar Datos</h5>
        <a href="/export/nodos.csv" class="btn btn-outline-info w-100 mb-2">Descargar Nodos CSV</a>
        <a href="/export/conexiones.csv" class="btn btn-outline-info w-100">Descargar Conexiones CSV</a>
    </div>
    <div id="map-container">
        <svg id="overlay"></svg>
    </div>

    <script>
        const nodes = [], connections = [];
        const map = document.getElementById('map-container');
        const svg = document.getElementById('overlay');

        map.addEventListener('click', e => {
            const rect = map.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const name = prompt('Nombre del nodo:');
            if (name) {
                fetch('/nodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, lat: x, lng: y })
                })
                    .then(res => res.json())
                    .then(n => {
                        nodes.push(n);
                        updateUI();
                    });
            }
        });

        function updateUI() {
            const list = document.getElementById('node-list');
            list.innerHTML = '';
            nodes.forEach(n => {
                const div = document.createElement('div');
                div.textContent = `${n.name} (${Math.round(n.lat)}, ${Math.round(n.lng)})`;
                list.appendChild(div);
            });
            ['origin-select', 'dest-select'].forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '';
                nodes.forEach(n => {
                    const o = document.createElement('option');
                    o.value = n.id;
                    o.textContent = n.name;
                    sel.appendChild(o);
                });
            });
            drawNodes();
            updateWaypointsList();
        }

        function drawNodes() {
            svg.innerHTML = '';
            nodes.forEach(n => {
                const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                c.setAttribute('cx', n.lat);
                c.setAttribute('cy', n.lng);
                c.setAttribute('r', 6);
                c.setAttribute('fill', 'red');
                svg.appendChild(c);

                const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                t.textContent = n.name;
                t.setAttribute('x', n.lat + 8);
                t.setAttribute('y', n.lng);
                t.setAttribute('class', 'node-label');
                svg.appendChild(t);
            });

            connections.forEach(c => {
                const from = nodes.find(n => n.id === c.from);
                const to = nodes.find(n => n.id === c.to);
                if (from && to) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', from.lat);
                    line.setAttribute('y1', from.lng);
                    line.setAttribute('x2', to.lat);
                    line.setAttribute('y2', to.lng);
                    line.setAttribute('stroke', '#0d6efd');
                    line.setAttribute('stroke-width', 3);
                    svg.appendChild(line);
                }
            });
        }

        document.getElementById('connect-btn').onclick = () => {
            const origin = +document.getElementById('origin-select').value;
            const dest = +document.getElementById('dest-select').value;
            if (origin === dest) return alert("El origen y destino no pueden ser iguales.");
            const weight = prompt('Peso de la conexión (ej. distancia):');
            if (!weight) return;
            fetch('/connections', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from: origin, to: dest, weight: +weight })
            })
                .then(res => res.json())
                .then(conn => {
                    connections.push(conn);
                    drawNodes();
                });
        };

        function updateWaypointsList() {
            const ul = document.getElementById('waypoints-list');
            ul.innerHTML = '';
            nodes.forEach(n => {
                const li = document.createElement('li');
                li.textContent = n.name;
                li.dataset.id = n.id;
                ul.appendChild(li);
            });
            new Sortable(ul, {
                animation: 150
            });
        }

        document.getElementById('calc-btn').onclick = () => {
            const origin = +document.getElementById('origin-select').value;
            const dest = +document.getElementById('dest-select').value;
            const waypoints = Array.from(document.querySelectorAll('#waypoints-list li'))
                .map(li => +li.dataset.id)
                .filter(id => id !== origin && id !== dest);
            fetch('/shortest_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ origin, dest, waypoints })
            })
                .then(async res => {
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ error: 'Error desconocido' }));
                        document.getElementById('route-result').innerHTML =
                            `<p class="text-danger">⚠️ Error: ${err.error}</p>`;
                        return;
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data) return;
                    document.getElementById('route-result').textContent =
                        data.path.map(n => n.name).join(' → ');
                    drawPath(data.path);
                });
        };

        function drawPath(path) {
            if (!path || path.length < 2) return;
            for (let i = 0; i < path.length - 1; i++) {
                const a = path[i], b = path[i + 1];
                const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                l.setAttribute('x1', a.lat); l.setAttribute('y1', a.lng);
                l.setAttribute('x2', b.lat); l.setAttribute('y2', b.lng);
                l.setAttribute('stroke', 'green');
                l.setAttribute('stroke-width', 4);
                svg.appendChild(l);
            }
        }

        document.getElementById('clear-btn').onclick = () => {
            svg.innerHTML = '';
            drawNodes();
            document.getElementById('route-result').textContent = '';
        };

        // Cargar nodos y conexiones desde la base de datos
        fetch('/nodes')
            .then(res => res.json())
            .then(data => {
                nodes.push(...data);
                updateUI();
            });

        fetch('/connections')
            .then(res => res.json())
            .then(data => {
                connections.push(...data);
                drawNodes();
            });
    </script>
</body>

</html>